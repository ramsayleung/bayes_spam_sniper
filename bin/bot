#!/usr/bin/env ruby

require_relative "../config/environment"

# This script runs the Telegram bot as a daemon process, it
# ensures there's only one bot instance running at a time, preventing the
# Telegram API conflict (error 409: "Conflict: terminated by other getUpdates request")

Rails.logger.info "Starting Telegram bot daemon..."

token = Rails.application.credentials.dig(:telegram_bot_token)
if token
  Rails.logger.info "Initializing Telegram bot..."

  # Disable query caching for the bot process since it runs indefinitely
  ActiveRecord::Base.uncached do
    current_bot = TelegramBotter.new
    current_bot.start_bot(token)
  end
else
  Rails.logger.error "No telegram bot token found in credentials!"
  exit(1)
end
